<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <div id="app">
    <div class="timeline_main">
      <div class="timeline_control">
        <div class="menu_play">
          <i class="menu_icon icon_left" :class="{'menu_icon_disabled':playing}" @click="backward"></i>
          <i class="menu_icon" :class="{'icon_play':!playing, 'icon_pause':playing}" @click="togglePlay"
            @mouseleave="hoverIndex = -1"></i>
          <i class="menu_icon icon_right" :class="{'menu_icon_disabled':playing}" @click="forward"></i>
        </div>
        <div class="menu_setting">
          <i class="menu_icon icon_up" :class="{'menu_icon_disabled':playing}" @click="speedSlow"></i>
          <i class="speed">{{ options.speed }}</i>
          <i class="menu_icon icon_down" :class="{'menu_icon_disabled':playing}" @click="speedQuick"></i>
        </div>
      </div>
      <div class="timeline_axis">
        <div class="axis_item" v-for="(time, index) in dateTimes" :key="index">
          <div class="axis_item_tick" :class="{ 'axis_item_tick_active':index === highlightIndex }"
            @mouseenter="hoverIndex = index" @mouseleave="hoverIndex = -1" @click="tickClick(time, index)"></div>
          <div class="axis_item_label" v-if="dateTimeIndexes.indexOf(index) >=0 ">{{ time }}</div>
          <div class="axis_item_tip" v-if="index === highlightIndex || index === hoverIndex">{{ time}}</div>
        </div>
      </div>
    </div>
  </div>
</body>
<script src='https://cdn.jsdelivr.net/npm/vue/dist/vue.js'></script>
<script>
  const app = new Vue({
    el: "#app",
    data: {
      time: '12321',
      intervalTimer: null, // 定时器
      dateTimeIndexes: [], // 日期列表
      playing: false, // 播放
      activeIndex: 0, // 当前的时间位置
      hoverIndex: 0, // 鼠标移入的时间位置
      options: {
        speed: 1, // 速度
        speedMax: 10 // 速度最大值
      },
      interval: 200, // 日期间的间隔
      dateTimes: [
        '03-04',
        '03-05',
        '03-06',
        '03-07',
        '03-08',
        '03-09',
        '03-10',
        '03-11',
        '03-12',
        '03-13'
      ]
    },
    computed: {
      highlightIndex() {
        return (
          (this.activeIndex === -1 && this.dateTimes.length - 1) ||
          this.activeIndex
        )
      }
    },
    watch: {
      options: {
        handler() {
          this.renderTimeline()
        },
        deep: true
      },
      playing() {
        if (this.playing) {
          this.intervalTimer = setInterval(() => {
            this.activeIndex = (this.activeIndex + 1) % this.dateTimes.length
          }, this.options.speed * 1000)
        } else {
          if (this.intervalTimer) {
            clearInterval(this.intervalTimer)
            this.intervalTimer = null
          }
        }
      },
      activeIndex() {
        const time = this.dateTimes[this.activeIndex].split(' ')[0]
        console.log(time)
        this.$emit('getDateFun', time)
      }
    },
    mounted() {
      this.renderTimeline()
      let that = this
      window.onresize = function () {
        that.renderTimeline()
      }
    },
    methods: {
      // 获取时间
      getDateFun(time) {
        console.log(time)
      },
      // 初始化时间轴
      renderTimeline() {
        // 时间轴的宽度
        const timelineWidth = this.$el.offsetWidth - 40
        // 日期个数
        const dateTimesSize = this.dateTimes.length
        // 如果时间全部显示，时间轴的理想宽度
        const dateTimesWidth = dateTimesSize * this.interval
        // 如果时间轴的宽度小于理想宽度
        if (timelineWidth >= dateTimesWidth) {
          this.dateTimeIndexes = this.dateTimes.map((dateTime, index) => {
            return index
          })
          return
        }
        // 当前时间轴的宽度最大能容纳多少日期刻度
        const maxTicks = Math.floor(timelineWidth / this.interval)
        // 间隔刻度数
        const gapTicks = Math.floor(dateTimesSize / maxTicks)
        // 记录需要显示的日期索引
        this.dateTimeIndexes = []
        for (let t = 0; t <= maxTicks; t++) {
          this.dateTimeIndexes.push(t * gapTicks)
        }
        const len = this.dateTimeIndexes.length
        // 最后一项需要特殊处理
        if (len > 0) {
          const lastIndex = this.dateTimeIndexes[len - 1]
          if (lastIndex + gapTicks > dateTimesSize - 1) {
            this.dateTimeIndexes[len - 1] = dateTimesSize - 1
          } else {
            this.dateTimeIndexes.push(dateTimesSize - 1)
          }
        }
      },
      // 点击刻度
      tickClick(time, index) {
        if (this.playing) {
          return
        }
        this.activeIndex = index
      },
      // 播放和暂停
      togglePlay() {
        this.playing = !this.playing
      },
      // 时间退后一日
      backward() {
        if (this.playing) {
          return
        }
        this.activeIndex = this.activeIndex - 1
        if (this.activeIndex === -1) {
          this.activeIndex = this.dateTimes.length - 1
        }
      },
      // 时间前进一日
      forward() {
        if (this.playing) {
          return
        }
        this.activeIndex = (this.activeIndex + 1) % this.dateTimes.length
      },
      // 减慢速度
      speedSlow() {
        if (this.playing || this.options.speed >= this.options.speedMax) {
          return
        }
        this.options.speed = this.options.speed + 1
      },
      // 加快速度
      speedQuick() {
        if (this.playing || this.options.speed <= 1) {
          return
        }
        this.options.speed = this.options.speed - 1
      }
    }
  })
</script>

</html>